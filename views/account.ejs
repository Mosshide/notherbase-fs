<div id="account" class="invisible content">
    <p id="please-login">Please login to view your account settings.</p>

    <div class="invisible settings">
        <h3>Email:</h3>
        <div class="setting" id="email">
            <p></p>
            <button onclick="accountServices.editEmail()">Change Email</button>
        </div>
        <div class="edit invisible" id="email">
            <input type="email" name="email">
            <button onclick="accountServices.updateEmail()">Update</button>
            <button onclick="accountServices.cancelEmail()">Cancel</button>
        </div>
    
        <hr>
    
        <h3>Username:</h3>
        <div class="setting" id="username">
            <p></p>
            <button onclick="accountServices.editUsername()">Change Username</button>
        </div>
        <div class="edit invisible" id="username">
            <input type="text" name="username">
            <button onclick="accountServices.updateUsername()">Update</button>
            <button onclick="accountServices.cancelUsername()">Cancel</button>
        </div>
    
        <hr>
    
        <h3>Password:</h3>
        <div class="setting" id="password">
            <p>*********</p>
            <p>Visit the Keeper to Change Your Password</p>
        </div>

        <p id="info"></p>
    </div>
</div>

<script>
    class AccountServices {
        constructor() {
            this.$emailSetting = $(".content#account .setting#email");
            this.$email = this.$emailSetting.find("p");
            this.$emailEdit = $(".content#account .edit#email");
            this.$emailInput = this.$emailEdit.find("input");

            this.$usernameSetting = $(".content#account .setting#username");
            this.$username = this.$usernameSetting.find("p");
            this.$usernameEdit = $(".content#account .edit#username");
            this.$usernameInput = this.$usernameEdit.find("input");

            this.$passwordSetting = $(".content#account .setting#password");
            this.$passwordEdit = $(".content#account .edit#password");
            this.$passwordInput = this.$passwordEdit.find("input");

            this.$info = $(".content#account #info");
            
            <% if (user) { %>
                this.username = "<%= user.username %>";
                this.email = "<%= user.email %>";

                this.refresh();
            <% } %>
        }

        async refresh() {
            this.$email.text(this.email);
            this.$emailInput.val(this.email);
            this.$username.text(this.username);
            this.$usernameInput.val(this.username);

            $(".content#account .settings").removeClass("invisible");
            $(".content#account #please-login").addClass("invisible");
        }

        editEmail() {
            this.$emailSetting.addClass("invisible");
            this.$emailEdit.removeClass("invisible");
        }

        cancelEmail() {
            this.$emailSetting.removeClass("invisible");
            this.$emailEdit.addClass("invisible");
            this.$emailInput.val(this.$email.text());
        }

        async updateEmail() {
            let response = await commune("changeUserEmail", { email: this.$emailInput.val() });

            this.$email.text(this.$emailInput.val());
            this.cancelEmail();
            this.$info.text("Email Updated!");

            location.reload();
        }

        editUsername() {
            this.$usernameSetting.addClass("invisible");
            this.$usernameEdit.removeClass("invisible");
        }

        cancelUsername() {
            this.$usernameSetting.removeClass("invisible");
            this.$usernameEdit.addClass("invisible");
            this.$usernameInput.val(this.$username.text());
        }

        async updateUsername() {
            let response = await commune("changeUsername", { username: this.$usernameInput.val() });

            this.$username.text(this.$usernameInput.val());
            this.cancelUsername();
            this.$info.text("Username Updated!");

            location.reload();
        }
    }

    let accountServices = new AccountServices();
</script>